#!/usr/bin/env bash
set -euo pipefail

SHEET="${SHEET:-targets.yml}"
RESULTS_FILE=".last_results.json"
DISK_PCT_DEFAULT="${DISK_PCT_DEFAULT:-90}"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing dependency: $1"; exit 1; }; }

need ansible-playbook
need python3
need ssh-keyscan
need ssh-keygen

if [[ ! -f "$SHEET" ]]; then
  echo "Cut sheet not found: $SHEET"
  exit 1
fi

# Ensure PyYAML exists
if ! python3 - <<'PY' >/dev/null 2>&1
import yaml  # noqa: F401
PY
then
  echo "Missing python dependency: pyyaml"
  echo "Install: pip3 install --user pyyaml"
  exit 2
fi

# Ensure SSH key exists
KEY="$HOME/.ssh/id_ed25519"
if [[ ! -f "$KEY" ]]; then
  echo "Generating SSH key at $KEY ..."
  ssh-keygen -t ed25519 -a 64 -f "$KEY" -N ""
fi

prompt_disk_pct() {
  local in=""
  read -rp "Disk full warning threshold percent [${DISK_PCT_DEFAULT}]: " in
  DISK_PCT="${in:-$DISK_PCT_DEFAULT}"
}

init_results() {
  python3 - "$RESULTS_FILE" <<'PY'
import json, sys
open(sys.argv[1], "w", encoding="utf-8").write(json.dumps({"results": []}, indent=2))
PY
}

append_result() {
  local name="$1" host="$2" ok="$3"
  python3 - "$RESULTS_FILE" "$name" "$host" "$ok" <<'PY'
import json, sys
path, name, host, ok = sys.argv[1:5]
data = json.load(open(path, "r", encoding="utf-8"))
data["results"].append({"name": name, "host": host, "ok": (ok == "true")})
open(path, "w", encoding="utf-8").write(json.dumps(data, indent=2))
PY
}

print_summary() {
  echo ""
  echo "========== SUMMARY =========="
  python3 - "$RESULTS_FILE" <<'PY'
import json, sys
data = json.load(open(sys.argv[1], "r", encoding="utf-8"))
ok = [r for r in data["results"] if r["ok"]]
bad = [r for r in data["results"] if not r["ok"]]
print(f"OK: {len(ok)}")
for r in ok:
  print(f"  ✅ {r['name']} ({r['host']})")
print(f"FAILED: {len(bad)}")
for r in bad:
  print(f"  ❌ {r['name']} ({r['host']})")
PY
}

# Build runlist TSV on stdout: name \t host \t port \t user \t url
build_runlist_tsv() {
  local mode="$1"
  local arg="${2:-}"
  python3 - "$SHEET" "$RESULTS_FILE" "$mode" "$arg" <<'PY'
import sys, json
import yaml

sheet, results_file, mode, arg = sys.argv[1:5]
data = yaml.safe_load(open(sheet, "r", encoding="utf-8")) or {}
targets = data.get("targets", [])
by_name = {t.get("name"): t for t in targets if t.get("name")}

def emit(t):
  print("\t".join([
    str(t.get("name","")),
    str(t.get("host","")),
    str(t.get("port",22)),
    str(t.get("user","root")),
    str(t.get("url","")),
  ]))

runlist = []
if mode == "all":
  runlist = targets
elif mode == "one":
  if arg in by_name:
    runlist = [by_name[arg]]
elif mode == "failed":
  try:
    last = json.load(open(results_file, "r", encoding="utf-8"))
    failed = [r["name"] for r in last.get("results", []) if r.get("ok") is False]
    runlist = [by_name[n] for n in failed if n in by_name]
  except FileNotFoundError:
    runlist = []

for t in runlist:
  emit(t)
PY
}

run_one() {
  local name="$1" host="$2" port="$3" user="$4" url="$5" disk_pct="$6"

  echo ""
  echo "=============================="
  echo "Running: $name"
  echo "SSH: $user@$host:$port"
  echo "URL: ${url:-<none>}"
  echo "Disk warn >= ${disk_pct}%"
  echo "=============================="

  # Pre-seed known_hosts so sshpass won't fail on host-key checking
  ssh-keyscan -p "$port" -H "$host" >> "$HOME/.ssh/known_hosts" 2>/dev/null || true

  local inv="${host},"

  # Bootstrap key (password prompt may appear first time)
  ansible-playbook -i "$inv" maintain_generic.yml \
    -u "$user" \
    -e "ansible_port=$port bootstrap_key=true disk_full_percent=$disk_pct url=$url" \
    --ask-pass --ask-become-pass

  # Run update + checks (key-based now)
  ansible-playbook -i "$inv" maintain_generic.yml \
    -u "$user" \
    -e "ansible_port=$port bootstrap_key=false disk_full_percent=$disk_pct url=$url" \
    --ask-become-pass
}

run_batch() {
  local mode="$1"
  local arg="${2:-}"
  local disk_pct="$3"

  local tmp="/tmp/runlist.tsv"
  build_runlist_tsv "$mode" "$arg" > "$tmp"

  if [[ ! -s "$tmp" ]]; then
    echo "No targets to run (mode=$mode ${arg:+arg=$arg})."
    return 1
  fi

  init_results

  local overall_fail=0

  while IFS=$'\t' read -r name host port user url; do
    [[ -z "$name" || -z "$host" ]] && continue

    if run_one "$name" "$host" "$port" "$user" "$url" "$disk_pct"; then
      echo "✅ $name OK"
      append_result "$name" "$host" "true"
    else
      echo "❌ $name FAILED"
      append_result "$name" "$host" "false"
      overall_fail=1
    fi

  done < "$tmp"

  print_summary

  if [[ $overall_fail -eq 0 ]]; then
    echo "hurray you didnt break anything...yet"
    return 0
  fi
  return 1
}

menu() {
  while true; do
    echo ""
    echo "What next?"
    echo "  1) Re-run FAILED"
    echo "  2) Re-run ALL"
    echo "  3) Run ONE (choose by name)"
    echo "  4) Exit"
    read -rp "Select [1-4]: " choice

    case "${choice:-4}" in
      1)
        prompt_disk_pct
        run_batch "failed" "" "$DISK_PCT" || true
        ;;
      2)
        prompt_disk_pct
        run_batch "all" "" "$DISK_PCT" || true
        ;;
      3)
        echo ""
        echo "Available targets:"
        python3 - "$SHEET" <<'PY'
import yaml, sys
data = yaml.safe_load(open(sys.argv[1], "r", encoding="utf-8")) or {}
for t in data.get("targets", []):
  if t.get("name"):
    print(" -", t["name"])
PY
        echo ""
        read -rp "Type target name exactly: " name
        prompt_disk_pct
        run_batch "one" "$name" "$DISK_PCT" || true
        ;;
      4)
        exit 0
        ;;
      *)
        echo "Invalid choice."
        ;;
    esac
  done
}

echo "=== Proxmox VM Maintenance Runner ==="
prompt_disk_pct
run_batch "all" "" "$DISK_PCT" || true
menu

